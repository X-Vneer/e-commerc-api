// ========================================
// Elwaha â€” Clothing Store API Schema
// ========================================

generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
}

// ======================
// ENUMS
// ======================

enum UserRole {
  user
  admin
  employee
}

enum Status {
  active
  inactive
  suspended
}

// ======================
// MODELS
// ======================

model User {
  id        String   @id @default(cuid())
  phone     String   @unique
  email     String?  @unique
  password  String
  name      String
  role      UserRole @default(user)
  status    Status   @default(active)
  region_id Int
  region    Region   @relation(fields: [region_id], references: [id])
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  favorites Color[]
  cart      Cart?

  @@index([phone])
  @@index([email])
}

model Admin {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      UserRole @default(employee)
  status    Status   @default(active)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
}

model Emirate {
  id      Int      @id @default(autoincrement())
  name_en String
  name_ar String
  regions Region[]
}

model Region {
  id         Int     @id @default(autoincrement())
  name_en    String
  name_ar    String
  emirate_id Int
  emirate    Emirate @relation(fields: [emirate_id], references: [id])
  users      User[]
}

// ======================
// Branches
// ======================

model Branch {
  id          Int                @id @default(autoincrement())
  name_en     String
  name_ar     String
  code        String             @unique
  inventories ProductInventory[]
}

model ProductInventory {
  id              Int         @id @default(autoincrement())
  product_size_id Int
  branch_id       Int
  amount          Int         @default(0)
  sold            Int         @default(0)
  productSize     ProductSize @relation(fields: [product_size_id], references: [id], onDelete: Cascade)
  branch          Branch      @relation(fields: [branch_id], references: [id], onDelete: Cascade)

  @@unique([product_size_id, branch_id]) // each size has one entry per branch
  @@index([amount])
  @@index([product_size_id])
}

// ======================
// PRODUCT + CATALOG
// ======================

model Category {
  id        Int       @id @default(autoincrement())
  name_en   String
  name_ar   String
  slug      String    @unique
  image     String
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Product {
  id             Int        @id @default(autoincrement())
  code           String     @unique
  slug           String     @unique
  name_en        String
  name_ar        String
  description_en String
  description_ar String
  price          Float
  main_image_url String
  is_active      Boolean    @default(true)
  is_featured    Boolean    @default(false)
  is_best_seller Boolean    @default(false)
  categories     Category[]
  colors         Color[]
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@index([is_active])
  @@index([createdAt])
  @@index([code])
  @@index([name_en])
  @@index([name_ar])
}

// ======================
// COLORS & SIZES
// ======================

model Color {
  id          Int           @id @default(autoincrement())
  product_id  Int
  product     Product       @relation(fields: [product_id], references: [id], onDelete: Cascade)
  name_en     String
  name_ar     String
  image       String
  sizes       ProductSize[]
  favorite_by User[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  cartItems   CartItem[]

  @@unique([product_id, name_en])
  @@unique([product_id, name_ar])
  @@index([product_id])
  @@index([name_en])
  @@index([name_ar])
}

model Size {
  id            Int           @id @default(autoincrement())
  code          String        @unique
  weight        String
  product_sizes ProductSize[]
}

model ProductSize {
  id          Int                @id @default(autoincrement())
  color_id    Int
  color       Color              @relation(fields: [color_id], references: [id], onDelete: Cascade)
  size_code   String
  size        Size               @relation(fields: [size_code], references: [code], onDelete: Cascade)
  inventories ProductInventory[]
  hip         Float
  chest       Float
  cartItems   CartItem[]

  // unique constraint on color_id and size_code
  @@unique([size_code, color_id])
  @@index([size_code, color_id])
  @@index([color_id])
  @@index([size_code])
}

// cart 
model Cart {
  id        String     @id @default(cuid())
  user_id   String     @unique
  user      User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  items     CartItem[]
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id        Int         @id @default(autoincrement())
  cart_id   String
  color_id  Int
  quantity  Int         @default(1)
  cart      Cart        @relation(fields: [cart_id], references: [id], onDelete: Cascade)
  color     Color       @relation(fields: [color_id], references: [id], onDelete: Cascade)
  size_code String
  size      ProductSize @relation(fields: [size_code, color_id], references: [size_code, color_id], onDelete: Cascade)

  @@unique([cart_id, color_id, size_code])
}
